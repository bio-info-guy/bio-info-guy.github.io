{
  "hash": "35b2eb2d59fa50ab4fc351684d7eccdd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Quality Control on Suspicious Clusters\"\ndate: \"2024-12-12\"\nformat:\n  html:\n    toc: true\n    toc_float:\n    toc_collapsed: true\n    html-math-method: katex\n    \n---\n\n\nThis tutorial touches on a common problem when performing quality control on scRNA-seq data:  **clusters that exhibit suspicious quality metrics**. Specifically, what should we do when we come across clusters with consistent QC metrics (i.e. High mitochondrial expression / low total counts) that differ consistently with other clusters. \n\n# Background\n**Common scRNA-seq workflow:**\n\n\n```{mermaid}\n%%| label: fig-1\n%%| fig-cap: Common scRNA-seq workflow\n%%| fig-align: center\nflowchart TD\n  A(Preprocessing + Quantification) --> B(<span style=\"color:red;\">Post-quantification QC and filtering</span>)\n  B --> C(Normalization)\n  C --> D(Integration)\n  D --> E(Clustering)\n  E --> G(<span style=\"color:red;\">Post-Clustering QC</span>)\n  E --> F(DE/Annotatation/Trajectory, etc.)\n  G --> F\n  \n```\n\n\nDuring post-quantification QC, metrics like the ones below are often calculated:\n\n* Total transcript count\n* Mt-RNA percentage\n* Total genes expressed\n* rRNA percentage\n* Proportion of reads in top expressed genes\n* Spike-ins percentage (if applicable)\n\nCells are then often filtered according to fixed thresholds: (i.e. < 500 genes expressed, > 10% mito-chondrial reads, >10 % rRNA reads) `OR` via adpative filtering theresholds using Median Absolute Deviation (i.e. `isOutlier` function in `scran`)\n\n\n# Causes\n1. Filtering was not stringent enough\n2. Possible biological composition \n    + tumor, cardiomyocytes, lung cells, high-metabolic cells, etc. may exhibit higher mitochondrial content\n    + quiescent / smaller cells may exhibit lower transcript levels\n\n# How to Check\n\n## QC metrics (filtering not stringent enough)\n\n* Look for correlations between different QC metrics\n* perform PCA and clustering on the quality metrcs to see if the same clusters appear\n* If batches exist, see if the same clusters in different batches exhibit similar quality metrics\n\n## Biological Markers and Pathways\n\n* `findMarker` genes and compare with known marker genes to evaluate if clusters are true clusters\n* Enrichment for relevant pathways and genesets and think of the biological relevance\n\n## Automated approaches\nThere are certain packages built to address these scenerios\n\n### MiQC\nJointly models the mitochondrial percentage and number of genes expressed to filter out cells\n\n### ddqc\nperforms dapative thresholding in each cluster after lenient filtering of samples and clustering to achieve biologically aware filtering of low quality samples\n\n\n\n## Examples\nWe provide some examples of using marker genes to evaluate whther or not the clusters in question are caused by biological or techincal factors\n\nload some packages first\n\n\n::: {.cell warnings='false'}\n\n```{.r .cell-code}\nlibrary(rfigshare)\nlibrary(SingleCellExperiment)\nlibrary(scater)\nlibrary(org.Hs.eg.db)\nlibrary(scran)\nlibrary(AnnotationHub)\n```\n:::\n\n\n\n### Zheng, 2017 dataset of 8 FACS sorted celltypes mixed with equal proportions\nThis dataset contains 8 different cell types that were sorted with FACS and mixed in-silico, thus cell labels are known ahead of time\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nzheng_data <- readRDS('/Users/ysu13/My Drive/Repos/myBlog/zheng_data.RDS')\nmito <- which(rowData(zheng_data)$SEQNAME==\"MT\")\nstats <- perCellQCMetrics(zheng_data, subsets=list(Mt=mito))\nqc <- quickPerCellQC(stats, percent_subsets=c(\"subsets_Mt_percent\",\n                                              \"total\", \"detected\"))\nzheng_data <- logNormCounts(zheng_data)\ngridExtra:::grid.arrange(\nplotColData(zheng_data, x=\"phenoid\", y=\"total_counts\", colour_by=\"is_cell_control\") + scale_y_log10() + ggtitle(\"Total count\"),\nplotColData(zheng_data, x=\"phenoid\", y=\"total_features\", colour_by=\"is_cell_control\") + scale_y_log10() + ggtitle(\"Number of Genes\"), nrow = 2)\n```\n\n::: {.cell-output-display}\n![zheng_data quality](index_files/figure-html/unnamed-chunk-3-1.png){fig-align='center' width=672}\n:::\n:::\n\n\n\n### Show marker genes for zheng data set\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngridExtra:::grid.arrange(\n  plotTSNE(zheng_data, colour_by = 'phenoid'),\n  plotTSNE(zheng_data, colour_by = 'CD14')\n, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n### He, 2020 dataset contains scRNA-seq for 15 different organs (only Heart samples are used here)\nThis dataset contains single cells from the heart, a certain degree of prefiltering has been performed (doublet removal, < 500 genes, < 1000 transcript counts and > 25% mitochondrial expression), the resulting clusters of heart samples are shown, cluster 7 shows higher mitochondrial content than other clusters\n  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhuman_heart <- scRNAseq::HeOrganAtlasData(tissue='heart')\n\nhuman_heart$mito_gt_5 <- human_heart$percent.mito > 0.05\nhuman_heart$mito_gt_10 <- human_heart$percent.mito > 0.1\nhuman_heart$log10_nCount_RNA <- log10(human_heart$nCount_RNA)\nhuman_heart$log10_nFeature_RNA <- log10(human_heart$nFeature_RNA)\nhuman_heart$seurat_clusters <- as.factor(human_heart$seurat_clusters)\nhuman_heart <- logNormCounts(human_heart)\ngridExtra:::grid.arrange(\nplotColData(human_heart, x=\"seurat_clusters\", y=\"percent.mito\",\n            colour_by=\"mito_gt_5\")  + ggtitle(\"Mitochondrial percentage\"),\nplotColData(human_heart, x = 'seurat_clusters', y = \"log10_nFeature_RNA\", color_by = 'mito_gt_5')+ ggtitle(\"Number of Genes\")\n, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n### Show marker genes for human heart dataset\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngridExtra:::grid.arrange(\n  plotTSNE(human_heart, colour_by = 'seurat_clusters'),\n  plotTSNE(human_heart, colour_by = 'MYH11')\n, nrow = 2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n# Downstream Analysis and Interpretation\nUltimately, it is up to the researcher to decide whther keeping the clusters is of relevance to the study",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}